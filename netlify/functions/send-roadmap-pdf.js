const { Resend } = require('resend');
const PDFDocument = require('pdfkit');

// Initialize Resend with API key from environment
const resend = new Resend(process.env.RESEND_API_KEY);

// Helper to format currency
const formatCurrency = (value) => {
  return new Intl.NumberFormat('en-AU', {
    style: 'currency',
    currency: 'AUD',
    minimumFractionDigits: 0,
    maximumFractionDigits: 0,
  }).format(value);
};

// Helper to format percentage
const formatPercent = (value) => {
  return new Intl.NumberFormat('en-AU', {
    style: 'percent',
    minimumFractionDigits: 1,
    maximumFractionDigits: 1,
  }).format(value);
};

// Generate PDF as buffer
const generatePDF = (data) => {
  return new Promise((resolve, reject) => {
    const doc = new PDFDocument({ margin: 50, size: 'A4' });
    const chunks = [];

    doc.on('data', (chunk) => chunks.push(chunk));
    doc.on('end', () => resolve(Buffer.concat(chunks)));
    doc.on('error', reject);

    // Header
    doc.fontSize(24).fillColor('#1f2937').text('Property Portfolio Roadmap', { align: 'center' });
    doc.moveDown(0.5);
    doc.fontSize(12).fillColor('#6b7280').text('Your personalised wealth building projection', { align: 'center' });
    doc.moveDown(2);

    // Summary Box
    const summaryY = doc.y;
    doc.rect(50, summaryY, 495, 120).fillAndStroke('#f0fdf4', '#bbf7d0');

    doc.fillColor('#166534').fontSize(14).text('Projected Outcome', 70, summaryY + 15);
    doc.moveDown(0.5);

    doc.fillColor('#1f2937').fontSize(28).text(formatCurrency(data.projectedIncome) + '/year', 70);
    doc.fontSize(11).fillColor('#6b7280').text(`Passive income after ${data.targetYears} years`, 70);

    // Stats row
    const statsY = summaryY + 80;
    doc.fontSize(10).fillColor('#6b7280');
    doc.text(`${data.totalProperties} properties`, 70, statsY);
    doc.text(`${data.debtFreeProperties} debt-free`, 200, statsY);
    doc.text(`${formatCurrency(data.portfolioValue)} portfolio`, 330, statsY);

    doc.y = summaryY + 140;

    // Your Inputs Section
    doc.moveDown(1);
    doc.fontSize(14).fillColor('#1f2937').text('Your Starting Position');
    doc.moveDown(0.5);

    doc.fontSize(10).fillColor('#6b7280');
    const inputsData = [
      ['Current Properties:', data.currentProperties.toString()],
      ['Cash to Invest:', formatCurrency(data.cashToInvest)],
      ['Target Timeline:', `${data.targetYears} years`],
      ['Income Goal:', formatCurrency(data.incomeGoal) + '/year'],
    ];

    inputsData.forEach(([label, value]) => {
      doc.fillColor('#6b7280').text(label, 70, doc.y, { continued: true, width: 150 });
      doc.fillColor('#1f2937').text(value);
    });

    // Assumptions Section
    doc.moveDown(1.5);
    doc.fontSize(14).fillColor('#1f2937').text('Key Assumptions');
    doc.moveDown(0.5);

    const assumptionsData = [
      ['Capital Growth:', formatPercent(data.assumptions.appreciationRate)],
      ['Rental Yield:', formatPercent(data.assumptions.rentalYield)],
      ['Interest Rate:', formatPercent(data.assumptions.interestRate)],
      ['Target Purchase Price:', formatCurrency(data.assumptions.averagePropertyPrice)],
    ];

    doc.fontSize(10);
    assumptionsData.forEach(([label, value]) => {
      doc.fillColor('#6b7280').text(label, 70, doc.y, { continued: true, width: 150 });
      doc.fillColor('#1f2937').text(value);
    });

    // Strategy Summary
    doc.moveDown(1.5);
    doc.fontSize(14).fillColor('#1f2937').text('Strategy Summary');
    doc.moveDown(0.5);

    doc.fontSize(10).fillColor('#4b5563');
    doc.text(`Over ${data.targetYears} years, this projection shows you acquiring ${data.propertiesBought} additional properties through strategic refinancing and cash investment. At the end of the period, you would sell ${data.propertiesToSell} properties to pay off all debt, leaving you with ${data.debtFreeProperties} debt-free properties generating ${formatCurrency(data.projectedIncome)} in annual passive income.`, {
      width: 475,
      align: 'left'
    });

    // Disclaimer
    doc.moveDown(2);
    doc.rect(50, doc.y, 495, 80).fillAndStroke('#fef3c7', '#fde68a');
    const disclaimerY = doc.y + 10;
    doc.fontSize(9).fillColor('#92400e').text('Important Disclaimer', 70, disclaimerY);
    doc.moveDown(0.3);
    doc.fontSize(8).fillColor('#a16207').text(
      'This projection is for illustrative purposes only and is based on the assumptions provided. Actual results will vary based on market conditions, your borrowing capacity, and other factors. This is not financial advice. Please consult with qualified financial advisors, mortgage brokers, and accountants before making investment decisions.',
      70, doc.y, { width: 455 }
    );

    // Footer
    doc.fontSize(8).fillColor('#9ca3af');
    doc.text('Generated by Property Portfolio Retirement Calculator', 50, 770, { align: 'center' });
    doc.text('property-retirement-calc.netlify.app', 50, 782, { align: 'center' });

    doc.end();
  });
};

exports.handler = async (event) => {
  // Only allow POST
  if (event.httpMethod !== 'POST') {
    return { statusCode: 405, body: 'Method Not Allowed' };
  }

  try {
    const data = JSON.parse(event.body);
    const { email, roadmapData, buyingSoon, openToContact } = data;

    if (!email || !roadmapData) {
      return {
        statusCode: 400,
        body: JSON.stringify({ error: 'Email and roadmap data required' })
      };
    }

    // Check if Resend API key is configured
    if (!process.env.RESEND_API_KEY) {
      console.error('RESEND_API_KEY not configured');
      return {
        statusCode: 500,
        body: JSON.stringify({ error: 'Email service not configured' })
      };
    }

    // Generate PDF
    const pdfBuffer = await generatePDF(roadmapData);

    // Send email with PDF attachment
    const { error } = await resend.emails.send({
      from: 'Property Calculator <roadmap@resend.dev>',
      to: email,
      subject: 'Your Property Portfolio Roadmap',
      html: `
        <div style="font-family: sans-serif; max-width: 600px; margin: 0 auto;">
          <h2 style="color: #1f2937;">Your Property Portfolio Roadmap</h2>
          <p style="color: #4b5563;">Thanks for using the Property Portfolio Retirement Calculator!</p>
          <p style="color: #4b5563;">Attached is your personalised roadmap showing how you could achieve <strong>${formatCurrency(roadmapData.projectedIncome)}/year</strong> in passive income over ${roadmapData.targetYears} years.</p>

          <div style="background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 8px; padding: 20px; margin: 20px 0;">
            <h3 style="color: #166534; margin-top: 0;">Quick Summary</h3>
            <ul style="color: #4b5563; margin: 0; padding-left: 20px;">
              <li>Starting with ${roadmapData.currentProperties} properties</li>
              <li>Acquiring ${roadmapData.propertiesBought} additional properties</li>
              <li>Ending with ${roadmapData.debtFreeProperties} debt-free properties</li>
              <li>Projected portfolio value: ${formatCurrency(roadmapData.portfolioValue)}</li>
            </ul>
          </div>

          <p style="color: #4b5563;">This projection is based on the assumptions you entered. Remember, actual results depend on market conditions, your borrowing capacity, and many other factors.</p>

          <p style="color: #6b7280; font-size: 14px; margin-top: 30px;">
            <a href="https://property-retirement-calc.netlify.app" style="color: #2563eb;">Return to the calculator</a> to adjust your assumptions and explore different scenarios.
          </p>

          <hr style="border: none; border-top: 1px solid #e5e7eb; margin: 30px 0;" />
          <p style="color: #9ca3af; font-size: 12px;">Property Portfolio Retirement Calculator</p>
        </div>
      `,
      attachments: [
        {
          filename: 'property-roadmap.pdf',
          content: pdfBuffer.toString('base64'),
        },
      ],
    });

    if (error) {
      console.error('Resend error:', error);
      return {
        statusCode: 500,
        body: JSON.stringify({ error: 'Failed to send email' })
      };
    }

    // Log lead info for later (you could also save to a database)
    console.log('Lead captured:', {
      email,
      buyingSoon,
      openToContact,
      projectedIncome: roadmapData.projectedIncome,
      timestamp: new Date().toISOString()
    });

    return {
      statusCode: 200,
      body: JSON.stringify({ success: true, message: 'Email sent successfully' })
    };

  } catch (error) {
    console.error('Function error:', error);
    return {
      statusCode: 500,
      body: JSON.stringify({ error: 'Internal server error' })
    };
  }
};
